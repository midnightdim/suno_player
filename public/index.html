<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Suno Player</title>
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icons8-play-arcade-16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icons8-play-arcade-32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/icons8-play-arcade-96.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0a0a0f;
      --bg-card: rgba(255, 255, 255, 0.04);
      --bg-glass: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.08);
      --text: #e8e8ed;
      --text-dim: #8888a0;
      --accent: #7c5cff;
      --accent-glow: rgba(124, 92, 255, 0.3);
      --trash: #ff4d6a;
      --ok: #f0a030;
      --good: #30d98c;
      --perfect: #7c5cff;
      --radius: 16px;
      --radius-sm: 10px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html,
    body {
      height: 100%;
      width: 100%;
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      padding: 20px;
      padding-bottom: calc(20px + var(--safe-bottom));
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .screen.active {
      display: flex;
    }

    /* â”€â”€ Home Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #home-screen {
      gap: 20px;
      background: radial-gradient(ellipse at 50% 0%, rgba(124, 92, 255, 0.10) 0%, transparent 60%);
    }

    .home-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .home-header h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .session-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .session-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      border-radius: var(--radius);
      background: var(--bg-card);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .session-card:hover {
      background: var(--bg-glass);
    }

    .session-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .session-info {
      flex: 1;
      min-width: 0;
    }

    .session-info .name {
      font-size: 15px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-info .meta {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 3px;
    }

    .session-delete {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-dim);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .session-delete:hover {
      background: rgba(255, 77, 106, 0.15);
      border-color: var(--trash);
      color: var(--trash);
    }

    .new-session-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      border-radius: var(--radius);
      background: var(--bg-card);
      border: 1px solid var(--border);
    }

    .new-session-form h3 {
      font-size: 14px;
      font-weight: 600;
    }

    /* â”€â”€ Setup Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #setup-screen {
      justify-content: center;
      align-items: center;
      gap: 28px;
      background: radial-gradient(ellipse at 50% 0%, rgba(124, 92, 255, 0.12) 0%, transparent 60%);
    }

    .setup-step {
      display: none;
      width: 100%;
      max-width: 420px;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .setup-step.active {
      display: flex;
    }

    .logo {
      font-size: 48px;
      margin-bottom: 4px;
    }

    .app-title {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .app-subtitle {
      font-size: 14px;
      color: var(--text-dim);
      max-width: 300px;
      text-align: center;
      line-height: 1.5;
    }

    .input-group {
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-group input:focus,
    .input-group textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .input-group textarea {
      min-height: 120px;
      resize: vertical;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border: none;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      -webkit-user-select: none;
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .btn-primary:hover {
      background: #6a4ae8;
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-glass);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 8px;
    }

    .btn-danger {
      background: rgba(255, 77, 106, 0.15);
      color: var(--trash);
      border: 1px solid rgba(255, 77, 106, 0.3);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      color: var(--text-dim);
      font-size: 14px;
      text-align: center;
    }

    .error-text {
      color: var(--trash);
      font-size: 13px;
      text-align: center;
    }

    /* â”€â”€ Player Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #player-screen {
      gap: 0;
      padding: 0;
      overflow: hidden;
    }

    .player-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px 8px;
      flex-shrink: 0;
    }

    .player-header .counter {
      font-size: 13px;
      color: var(--text-dim);
      font-weight: 500;
    }

    .player-header .controls {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      color: var(--text-dim);
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }

    .icon-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .album-art-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 30px;
      min-height: 0;
      position: relative;
      overflow: hidden;
    }

    .album-art-bg {
      position: absolute;
      inset: -40px;
      z-index: 0;
      background-size: cover;
      background-position: center;
      filter: blur(60px) brightness(0.3) saturate(1.4);
      opacity: 0.6;
      transition: background-image 0.8s;
    }

    .album-art {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 340px;
      aspect-ratio: 1;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      background: var(--bg-card);
      transition: opacity 0.3s;
    }

    .album-art img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .album-art .fallback {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
    }

    .track-info {
      padding: 12px 24px 4px;
      text-align: center;
      flex-shrink: 0;
    }

    .track-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .track-style {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .audio-controls {
      padding: 8px 24px 4px;
      flex-shrink: 0;
    }

    .progress-bar-container {
      width: 100%;
      height: 28px;
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
    }

    .progress-bar-track {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      width: 0%;
      transition: width 0.1s linear;
    }

    .progress-bar-container:active .progress-bar-track {
      height: 6px;
    }

    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-dim);
      font-variant-numeric: tabular-nums;
      padding: 0 2px;
    }

    .playback-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 4px 24px;
      flex-shrink: 0;
    }

    .play-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--text);
      color: var(--bg);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      transition: transform 0.15s;
    }

    .play-btn:active {
      transform: scale(0.92);
    }

    .skip-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .skip-btn:hover {
      opacity: 1;
    }

    .rating-section {
      padding: 10px 20px 2px;
      flex-shrink: 0;
    }

    .rating-buttons {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .rate-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      padding: 10px 4px;
      border-radius: var(--radius-sm);
      background: var(--bg-glass);
      border: 1.5px solid var(--border);
      color: var(--text);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      user-select: none;
      -webkit-user-select: none;
    }

    .rate-btn:active {
      transform: scale(0.94);
    }

    .rate-btn .emoji {
      font-size: 20px;
    }

    .rate-btn .label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .rate-btn[data-rating="TRASH"] {
      border-color: rgba(255, 77, 106, 0.3);
    }

    .rate-btn[data-rating="TRASH"]:hover,
    .rate-btn[data-rating="TRASH"].selected {
      background: rgba(255, 77, 106, 0.15);
      border-color: var(--trash);
    }

    .rate-btn[data-rating="OK"] {
      border-color: rgba(240, 160, 48, 0.3);
    }

    .rate-btn[data-rating="OK"]:hover,
    .rate-btn[data-rating="OK"].selected {
      background: rgba(240, 160, 48, 0.15);
      border-color: var(--ok);
    }

    .rate-btn[data-rating="GOOD"] {
      border-color: rgba(48, 217, 140, 0.3);
    }

    .rate-btn[data-rating="GOOD"]:hover,
    .rate-btn[data-rating="GOOD"].selected {
      background: rgba(48, 217, 140, 0.15);
      border-color: var(--good);
    }

    .rate-btn[data-rating="PERFECT"] {
      border-color: rgba(124, 92, 255, 0.3);
    }

    .rate-btn[data-rating="PERFECT"]:hover,
    .rate-btn[data-rating="PERFECT"].selected {
      background: rgba(124, 92, 255, 0.15);
      border-color: var(--perfect);
    }

    .rate-btn[data-rating="CLEAR"] {
      border-color: rgba(255, 255, 255, 0.15);
    }

    .rate-btn[data-rating="CLEAR"]:hover,
    .rate-btn[data-rating="CLEAR"].selected {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--text-dim);
    }

    .note-section {
      padding: 0 20px 6px;
      flex-shrink: 0;
    }

    .note-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .note-input {
      flex: 1;
      padding: 10px 14px;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }

    .note-input:focus {
      border-color: var(--accent);
    }

    .note-input::placeholder {
      color: var(--text-dim);
    }

    .note-display {
      padding: 0 20px 4px;
      flex-shrink: 0;
    }

    .note-display .note-text {
      font-size: 12px;
      color: var(--ok);
      font-style: italic;
      text-align: center;
    }

    .bottom-bar {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 6px 20px calc(6px + var(--safe-bottom));
      flex-shrink: 0;
    }

    /* â”€â”€ Results Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #results-screen {
      gap: 16px;
      background: var(--bg);
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .results-header h2 {
      font-size: 22px;
      font-weight: 700;
    }

    .filter-tabs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .filter-tab {
      padding: 7px 14px;
      border-radius: 20px;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      color: var(--text-dim);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .filter-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .results-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      -webkit-overflow-scrolling: touch;
    }

    .result-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      border: 1px solid var(--border);
      transition: background 0.2s;
    }

    .result-card:hover {
      background: var(--bg-glass);
    }

    .result-thumb {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
      background: var(--bg-glass);
    }

    .result-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .result-info {
      flex: 1;
      min-width: 0;
    }

    .result-info .title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .result-info .meta {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 2px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      cursor: pointer;
    }

    .result-info .meta.expanded {
      -webkit-line-clamp: unset;
      line-clamp: unset;
    }

    .result-info .note {
      font-size: 11px;
      color: var(--ok);
      font-style: italic;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .result-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .badge-TRASH {
      background: rgba(255, 77, 106, 0.15);
      color: var(--trash);
    }

    .badge-OK {
      background: rgba(240, 160, 48, 0.15);
      color: var(--ok);
    }

    .badge-GOOD {
      background: rgba(48, 217, 140, 0.15);
      color: var(--good);
    }

    .badge-PERFECT {
      background: rgba(124, 92, 255, 0.15);
      color: var(--perfect);
    }

    .result-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .result-actions button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-glass);
      border: 1px solid var(--border);
      color: var(--text-dim);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .result-actions button:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--text);
    }

    .results-footer {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      flex-shrink: 0;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-dim);
    }

    .empty-state .icon {
      font-size: 48px;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* â”€â”€ Tabs row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-row {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .tab-row .btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    /* â”€â”€ Icon Picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .icon-picker {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .icon-picker button {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--bg-glass);
      border: 2px solid var(--border);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-picker button:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .icon-picker button.selected {
      border-color: var(--accent);
      background: rgba(124, 92, 255, 0.15);
    }

    .icon-picker .custom-icon-input {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--bg-glass);
      border: 2px dashed var(--border);
      font-size: 20px;
      color: var(--text);
      text-align: center;
      outline: none;
      transition: all 0.2s;
      padding: 0;
    }

    .icon-picker .custom-icon-input:focus,
    .icon-picker .custom-icon-input.selected {
      border: 2px solid var(--accent);
      background: rgba(124, 92, 255, 0.15);
      border-style: solid;
    }

    .icon-picker .custom-icon-input::placeholder {
      color: var(--text-dim);
    }

    .lock-badge {
      font-size: 14px;
      flex-shrink: 0;
      margin-right: 4px;
    }

    /* â”€â”€ Password Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 50;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(4px);
    }

    .modal-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      max-width: 360px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast-container {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      padding: 10px 20px;
      border-radius: 10px;
      background: rgba(40, 40, 60, 0.95);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      animation: toast-in 0.3s ease-out;
      pointer-events: auto;
    }

    .toast.out {
      animation: toast-out 0.3s ease-in forwards;
    }

    @keyframes toast-in {
      from {
        opacity: 0;
        transform: translateY(-12px);
      }
    }

    @keyframes toast-out {
      to {
        opacity: 0;
        transform: translateY(-12px);
      }
    }

    .hidden {
      display: none !important;
    }

    @media (min-width:640px) {
      .album-art {
        max-width: 300px;
      }

      .rating-section,
      .note-section,
      .audio-controls,
      .playback-controls,
      .bottom-bar,
      .note-display {
        max-width: 480px;
        margin-left: auto;
        margin-right: auto;
        width: 100%;
      }
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 2px;
    }
  </style>
</head>

<body>

  <div class="toast-container" id="toast-container"></div>

  <!-- Edit Session Modal -->
  <div class="modal-overlay hidden" id="edit-session-modal">
    <div class="modal-box" style="max-width:400px;width:100%;align-items:stretch;">
      <h3 style="text-align:center;margin-top:0;">Edit Session</h3>
      <div class="input-group"><label>Session Name</label><input id="edit-session-name"></div>
      <div class="input-group"><label>Icon</label>
        <div class="icon-picker" id="edit-icon-picker"></div>
      </div>
      <div style="margin-top:10px;font-weight:600;">Import More Tracks</div>
      <div class="tab-row">
        <button class="btn btn-secondary btn-sm active" id="edit-tab-ids" onclick="switchEditTab('ids')">Paste
          IDs</button>
        <button class="btn btn-secondary btn-sm" id="edit-tab-workspace" onclick="switchEditTab('workspace')">From
          Workspace</button>
      </div>
      <div id="edit-tab-ids-content">
        <div class="input-group"><label>Track IDs</label><textarea id="edit-track-ids"
            placeholder="Paste additional IDs" style="min-height:60px;"></textarea></div>
      </div>
      <div id="edit-tab-workspace-content" class="hidden">
        <div class="input-group"><label>Workspace ID</label><input id="edit-workspace-id"
            placeholder="bdec811e-d376-409e-a12c-33261e3d7b10"></div>
      </div>
      <div id="edit-error" class="error-text hidden"></div>
      <div id="edit-loading" class="hidden" style="display:flex;gap:10px;align-items:center;">Fetching...</div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn btn-secondary" style="flex:1;" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" style="flex:1;" id="edit-save-btn" onclick="saveEditedSession()">Save</button>
      </div>
    </div>
  </div>

  <!-- â•â•â• HOME SCREEN â•â•â• -->
  <div class="screen active" id="home-screen">
    <div class="home-header">
      <h1>ğŸµ Suno Player</h1>
      <button class="btn btn-secondary btn-sm" onclick="showAuthSetup()">ğŸ”‘ Auth</button>
    </div>
    <div id="auth-status" style="font-size:12px;color:var(--text-dim);"></div>
    <div class="session-list" id="session-list"></div>
    <div class="new-session-form">
      <h3>New Session</h3>
      <div class="input-group"><label>Session Name</label><input id="new-session-name"
          placeholder="e.g. Covers Batch 3"></div>
      <div class="input-group"><label>Icon</label>
        <div class="icon-picker" id="icon-picker"></div>
      </div>
      <div class="input-group"><label>Password (optional)</label><input type="password" id="new-session-password"
          placeholder="Leave empty for no protection"></div>
      <div class="tab-row">
        <button class="btn btn-secondary btn-sm active" id="tab-ids" onclick="switchNewTab('ids')">Paste IDs</button>
        <button class="btn btn-secondary btn-sm" id="tab-workspace" onclick="switchNewTab('workspace')">From
          Workspace</button>
      </div>
      <div id="new-tab-ids">
        <div class="input-group"><label>Track IDs</label><textarea id="new-track-ids"
            placeholder="Paste IDs, one per line or comma-separated"></textarea></div>
      </div>
      <div id="new-tab-workspace" class="hidden">
        <div class="input-group"><label>Workspace ID</label><input id="new-workspace-id"
            placeholder="bdec811e-d376-409e-a12c-33261e3d7b10"></div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:-4px;">Find this in the Suno URL when viewing a
          workspace</div>
      </div>
      <button class="btn btn-primary" id="create-session-btn" onclick="createSession()">Create Session</button>
      <div id="create-error" class="error-text hidden"></div>
      <div id="create-loading" class="hidden" style="display:flex;gap:10px;align-items:center;">
        <div class="loading-spinner" style="width:24px;height:24px;border-width:2px;"></div><span class="loading-text"
          id="create-loading-text">Fetching tracks...</span>
      </div>
    </div>
  </div>

  <!-- â•â•â• AUTH SETUP â•â•â• -->
  <div class="screen" id="auth-screen">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:24px;">
      <div class="logo">ğŸ”‘</div>
      <div class="app-title">Auth Setup</div>
      <div class="app-subtitle">Paste your Suno Bearer token to enable metadata fetching and workspace import.</div>
      <div class="input-group" style="max-width:420px;">
        <label>Authorization Token</label>
        <input type="password" id="auth-token" placeholder="Bearer eyJhbGciOi..." autocomplete="off">
      </div>
      <button class="btn btn-primary" onclick="submitAuth()">Save Token</button>
      <button class="btn btn-secondary btn-sm" onclick="switchScreen('home-screen'); refreshHome()">â† Back</button>
      <div id="auth-error" class="error-text hidden"></div>
    </div>
  </div>

  <!-- â•â•â• PLAYER SCREEN â•â•â• -->
  <div class="screen" id="player-screen">
    <div class="player-header">
      <span class="counter" id="track-counter">1 / 32</span>
      <div class="controls">
        <button class="icon-btn" id="home-btn" onclick="goHome()" title="Home">ğŸ </button>
        <button class="icon-btn active" id="shuffle-btn" onclick="toggleShuffle()" title="Shuffle">ğŸ”€</button>
        <button class="icon-btn active" id="auto-advance-btn" onclick="toggleAutoAdvance()"
          title="Auto-advance">â­ï¸</button>
        <button class="icon-btn" id="results-btn" onclick="showResults()" title="Results">ğŸ“Š</button>
      </div>
    </div>
    <div class="album-art-container">
      <div class="album-art-bg" id="art-bg"></div>
      <div class="album-art" id="album-art">
        <img id="art-img" src="" alt=""
          onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
        <div class="fallback" style="display:none;">ğŸ¶</div>
      </div>
    </div>
    <div class="track-info">
      <div class="track-title" id="track-title">Loading...</div>
      <div class="track-style" id="track-style"></div>
    </div>
    <div class="note-display" id="note-display-area">
      <div class="note-text" id="note-display-text"></div>
    </div>
    <div class="audio-controls">
      <div class="progress-bar-container" id="progress-container">
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progress-fill"></div>
        </div>
      </div>
      <div class="time-display"><span id="time-current">0:00</span><span id="time-duration">0:00</span></div>
    </div>
    <div class="playback-controls">
      <button class="skip-btn" onclick="prevTrack()">â®</button>
      <button class="play-btn" id="play-btn" onclick="togglePlay()">â–¶</button>
      <button class="skip-btn" onclick="nextTrack()">â­</button>
    </div>
    <div class="rating-section">
      <div class="rating-buttons">
        <button class="rate-btn" data-rating="TRASH" onclick="rateTrack('TRASH')"><span class="emoji">ğŸ—‘ï¸</span><span
            class="label">Trash</span></button>
        <button class="rate-btn" data-rating="OK" onclick="rateTrack('OK')"><span class="emoji">ğŸ‘Œ</span><span
            class="label">OK</span></button>
        <button class="rate-btn" data-rating="GOOD" onclick="rateTrack('GOOD')"><span class="emoji">ğŸ‘</span><span
            class="label">Good</span></button>
        <button class="rate-btn" data-rating="PERFECT" onclick="rateTrack('PERFECT')"><span class="emoji">â­</span><span
            class="label">Perfect</span></button>
        <button class="rate-btn" data-rating="CLEAR" onclick="rateTrack(null)"><span class="emoji">â†©ï¸</span><span
            class="label">Clear</span></button>
      </div>
    </div>
    <div class="note-section">
      <div class="note-row">
        <input class="note-input" id="note-input" type="text" placeholder="Add a note..." maxlength="200">
        <button class="btn btn-secondary btn-sm" onclick="saveNote()">ğŸ’¾</button>
      </div>
    </div>
    <div class="bottom-bar">
      <button class="btn btn-secondary btn-sm" onclick="openSunoPage()">ğŸ”— Suno</button>
    </div>
  </div>

  <!-- â•â•â• RESULTS SCREEN â•â•â• -->
  <div class="screen" id="results-screen">
    <div class="results-header">
      <h2>Ratings</h2>
      <div style="display:flex;gap:8px;">
        <button class="icon-btn" onclick="showPlayer()" title="Back to player">ğŸµ</button>
        <button class="icon-btn" onclick="goHome()" title="Home">ğŸ </button>
      </div>
    </div>
    <div class="filter-tabs" id="filter-tabs">
      <button class="filter-tab active" data-filter="ALL" onclick="filterResults('ALL')">All</button>
      <button class="filter-tab" data-filter="PERFECT" onclick="filterResults('PERFECT')">â­ Perfect</button>
      <button class="filter-tab" data-filter="GOOD" onclick="filterResults('GOOD')">ğŸ‘ Good</button>
      <button class="filter-tab" data-filter="OK" onclick="filterResults('OK')">ğŸ‘Œ OK</button>
      <button class="filter-tab" data-filter="TRASH" onclick="filterResults('TRASH')">ğŸ—‘ï¸ Trash</button>
      <button class="filter-tab" data-filter="UNRATED" onclick="filterResults('UNRATED')">â€” Unrated</button>
    </div>
    <div class="results-list" id="results-list"></div>
    <div class="results-footer">
      <button class="btn btn-secondary btn-sm" onclick="exportRatings()">ğŸ“¥ Export JSON</button>
      <button class="btn btn-secondary btn-sm" onclick="downloadPerfect()">â­ Download Perfect</button>
      <button class="btn btn-secondary btn-sm" onclick="copyRatingSummary()">ğŸ“‹ Copy Summary</button>
    </div>
  </div>

  <audio id="audio" preload="auto"></audio>

  <script>
    // â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentSessionId = null;
    let sessionData = null;  // { name, tracks:[], ratings:{}, createdAt }
    let playQueue = [];
    let queuePos = -1;
    let shuffleOn = true;
    let autoAdvance = true;
    let currentFilter = 'ALL';
    let newTabMode = 'ids';
    let selectedIcon = 'ğŸ§';
    let editTabMode = 'ids';
    let editSelectedIcon = 'ğŸ§';
    let editingSessionId = null;
    const SESSION_ICONS = ['ğŸ§', 'ğŸµ', 'ğŸ¸', 'ğŸ¹', 'ğŸ¥', 'ğŸ¤', 'ğŸº', 'ğŸ»', 'ğŸ¶', 'ğŸ¼', 'ğŸ”¥', 'ğŸ’', 'ğŸŒŸ', 'ğŸŒ™', 'ğŸš€', 'ğŸ’œ'];

    const audio = document.getElementById('audio');

    // â•â•â• HELPERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function toast(msg, dur = 2000) { const c = document.getElementById('toast-container'), e = document.createElement('div'); e.className = 'toast'; e.textContent = msg; c.appendChild(e); setTimeout(() => { e.classList.add('out'); setTimeout(() => e.remove(), 300); }, dur); }
    function showError(id, msg) { const e = document.getElementById(id); e.textContent = msg; e.classList.remove('hidden'); }
    function hideError(id) { document.getElementById(id).classList.add('hidden'); }
    function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function formatTime(s) { if (!s || isNaN(s)) return '0:00'; return `${Math.floor(s / 60)}:${Math.floor(s % 60).toString().padStart(2, '0')}`; }

    // â•â•â• HOME SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function refreshHome() {
      // Check auth
      const hasToken = !!localStorage.getItem('sunoAuthToken');
      document.getElementById('auth-status').textContent = hasToken ? 'âœ… Auth token set' : 'âš ï¸ No auth token â€” workspace import and metadata disabled';

      // Load sessions
      try {
        const r = await fetch('/api/sessions');
        const sessions = await r.json();
        const list = document.getElementById('session-list');
        if (sessions.length === 0) {
          list.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>No sessions yet. Create one below.</p></div>';
          return;
        }
        list.innerHTML = sessions.map(s => `
      <div class="session-card" onclick="openSession('${s.id}')">
        <div class="session-icon">${s.icon || 'ğŸ§'}</div>
        <div class="session-info">
          <div class="name">${s.locked ? '<span class="lock-badge">ğŸ”’</span>' : ''}${escHtml(s.name)}</div>
          <div class="meta">${s.trackCount} tracks Â· ${s.ratedCount} rated Â· ${new Date(s.createdAt).toLocaleDateString()}</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="session-delete" style="background:var(--bg-glass);" onclick="event.stopPropagation();openEditModal('${s.id}','${escHtml(s.name)}','${s.icon || 'ğŸ§'}')" title="Edit">âœï¸</button>
          <button class="session-delete" onclick="event.stopPropagation();deleteSession('${s.id}','${escHtml(s.name)}')" title="Delete">ğŸ—‘ï¸</button>
        </div>
      </div>
    `).join('');
      } catch (e) {
        document.getElementById('session-list').innerHTML = '<div class="error-text">Failed to load sessions</div>';
      }
    }

    async function deleteSession(id, name) {
      if (!confirm(`Delete session "${name}"?`)) return;
      await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
      toast('Session deleted');
      refreshHome();
    }

    function switchNewTab(tab) {
      newTabMode = tab;
      document.getElementById('new-tab-ids').classList.toggle('hidden', tab !== 'ids');
      document.getElementById('new-tab-workspace').classList.toggle('hidden', tab !== 'workspace');
      document.getElementById('tab-ids').classList.toggle('active', tab === 'ids');
      document.getElementById('tab-workspace').classList.toggle('active', tab === 'workspace');
    }

    async function createSession() {
      const name = document.getElementById('new-session-name').value.trim();
      if (!name) { showError('create-error', 'Enter a session name'); return; }
      hideError('create-error');

      let tracks = [];

      if (newTabMode === 'ids') {
        const raw = document.getElementById('new-track-ids').value.trim();
        if (!raw) { showError('create-error', 'Paste at least one track ID'); return; }
        let ids = raw.replace(/[\[\]"']/g, '').split(/[\n,\s]+/).map(s => s.trim()).filter(s => /^[a-f0-9-]{36}$/i.test(s));
        ids = [...new Set(ids)];
        if (ids.length === 0) { showError('create-error', 'No valid UUIDs found'); return; }

        // Show loading
        document.getElementById('create-session-btn').classList.add('hidden');
        document.getElementById('create-loading').classList.remove('hidden');
        document.getElementById('create-loading-text').textContent = `Fetching metadata for ${ids.length} tracks...`;

        try {
          const auth = localStorage.getItem('sunoAuthToken') || '';
          const r = await fetch('/api/metadata', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': auth }, body: JSON.stringify({ ids }) });
          const d = await r.json();
          if (!r.ok) throw new Error(d.error);
          tracks = d.tracks;
        } catch (e) {
          showError('create-error', e.message);
          document.getElementById('create-session-btn').classList.remove('hidden');
          document.getElementById('create-loading').classList.add('hidden');
          return;
        }
      } else {
        const wid = document.getElementById('new-workspace-id').value.trim();
        if (!wid) { showError('create-error', 'Enter a workspace ID'); return; }

        document.getElementById('create-session-btn').classList.add('hidden');
        document.getElementById('create-loading').classList.remove('hidden');
        document.getElementById('create-loading-text').textContent = 'Fetching tracks from workspace...';

        try {
          const auth = localStorage.getItem('sunoAuthToken') || '';
          const r = await fetch('/api/workspace', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': auth }, body: JSON.stringify({ workspaceId: wid }) });
          const d = await r.json();
          if (!r.ok) throw new Error(d.error);
          tracks = d.tracks;
          document.getElementById('create-loading-text').textContent = `Found ${tracks.length} tracks!`;
        } catch (e) {
          showError('create-error', e.message);
          document.getElementById('create-session-btn').classList.remove('hidden');
          document.getElementById('create-loading').classList.add('hidden');
          return;
        }
      }

      // Create session on server
      const password = document.getElementById('new-session-password').value;
      try {
        const r = await fetch('/api/sessions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, tracks, icon: selectedIcon, password: password || undefined }) });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error);
        toast(`Created session with ${tracks.length} tracks`);

        // Reset form
        document.getElementById('new-session-name').value = '';
        document.getElementById('new-track-ids').value = '';
        document.getElementById('new-workspace-id').value = '';
        document.getElementById('new-session-password').value = '';
        selectedIcon = 'ğŸ§'; initIconPicker();
        document.getElementById('create-session-btn').classList.remove('hidden');
        document.getElementById('create-loading').classList.add('hidden');

        // Open the session
        openSession(d.id, password || null);
      } catch (e) {
        showError('create-error', e.message);
        document.getElementById('create-session-btn').classList.remove('hidden');
        document.getElementById('create-loading').classList.add('hidden');
      }
    }

    // â•â•â• SESSION LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function openSession(id, autoPassword = null) {
      try {
        let r = await fetch(`/api/sessions/${id}`);
        let d = await r.json();

        // If locked, prompt for password
        if (r.status === 403 && d.locked) {
          let pw = autoPassword;
          if (!pw) {
            pw = await promptPassword();
            if (pw === null) return; // cancelled
          }
          r = await fetch(`/api/sessions/${id}/unlock`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pw }) });
          d = await r.json();
          if (!r.ok) { toast('Wrong password'); return; }
        } else if (!r.ok) {
          throw new Error(d.error);
        }

        currentSessionId = id;
        sessionData = d;
        buildQueue();
        updateToggles();
        switchScreen('player-screen');
        if (playQueue.length > 0) { queuePos = 0; loadTrack(); }
        else { toast('No unrated tracks left'); showResults(); }
      } catch (e) { toast('Failed to open session: ' + e.message); }
    }

    function goHome() {
      audio.pause();
      currentSessionId = null;
      sessionData = null;
      switchScreen('home-screen');
      refreshHome();
    }

    // â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showAuthSetup() { switchScreen('auth-screen'); }

    async function submitAuth() {
      let token = document.getElementById('auth-token').value.trim();
      if (!token) { showError('auth-error', 'Paste your token'); return; }
      hideError('auth-error');
      // Strip non-ASCII chars
      token = token.replace(/[^\x00-\x7F]/g, '').trim();
      token = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
      localStorage.setItem('sunoAuthToken', token);
      toast('Token saved locally!');
      switchScreen('home-screen');
      refreshHome();
    }

    // â•â•â• QUEUE & PLAYBACK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function buildQueue() {
      if (!sessionData) return;
      const unrated = [];
      sessionData.tracks.forEach((t, i) => {
        const r = sessionData.ratings?.[t.id];
        if (!r || !r.rating) unrated.push(i);
      });
      playQueue = shuffleOn ? shuffle([...unrated]) : [...unrated];
      queuePos = -1;
    }

    function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

    function loadTrack(shouldPlay = true) {
      if (!sessionData || queuePos < 0 || queuePos >= playQueue.length) { updateCounter(); return; }
      const track = sessionData.tracks[playQueue[queuePos]];
      if (!track) return;

      document.getElementById('track-title').textContent = track.title || `Track ${track.id.slice(0, 8)}...`;
      document.getElementById('track-style').textContent = track.style || '';

      const img = document.getElementById('art-img'), fb = img.nextElementSibling;
      img.style.display = ''; fb.style.display = 'none'; img.src = track.imageUrl || '';
      document.getElementById('art-bg').style.backgroundImage = track.imageUrl ? `url(${track.imageUrl})` : '';

      // Rating & note display
      const existing = sessionData.ratings?.[track.id];
      document.getElementById('note-input').value = existing?.note || '';
      const noteText = existing?.note || '';
      const noteArea = document.getElementById('note-display-text');
      noteArea.textContent = noteText ? `ğŸ“ ${noteText}` : '';

      document.querySelectorAll('.rate-btn').forEach(btn => {
        const r = btn.dataset.rating;
        btn.classList.toggle('selected', r === 'CLEAR' ? false : existing?.rating === r);
      });

      audio.src = track.audioUrl;
      if (shouldPlay) audio.play().catch(() => { });
      updateCounter();
      updatePlayBtn();
    }

    function updateCounter() {
      const remaining = playQueue.length - queuePos - 1;
      const total = sessionData ? sessionData.tracks.length : 0;
      const rated = sessionData ? Object.values(sessionData.ratings || {}).filter(r => r.rating).length : 0;
      document.getElementById('track-counter').textContent = `${Math.min(queuePos + 1, playQueue.length)} / ${playQueue.length} unrated Â· ${rated}/${total} rated`;
    }

    function nextTrack() {
      queuePos++;
      if (queuePos >= playQueue.length) {
        buildQueue();
        if (playQueue.length === 0) { toast('All tracks rated! ğŸ‰'); showResults(); return; }
        queuePos = 0;
      }
      loadTrack();
    }

    function prevTrack() { if (queuePos > 0) { queuePos--; loadTrack(); } }

    function togglePlay() { if (audio.paused) audio.play().catch(() => { }); else audio.pause(); updatePlayBtn(); }
    function updatePlayBtn() { document.getElementById('play-btn').textContent = audio.paused ? 'â–¶' : 'â¸'; }

    audio.addEventListener('play', updatePlayBtn);
    audio.addEventListener('pause', updatePlayBtn);
    audio.addEventListener('ended', () => { updatePlayBtn(); if (autoAdvance) { const t = sessionData?.tracks[playQueue[queuePos]]; if (t && sessionData.ratings?.[t.id]?.rating) nextTrack(); } });
    audio.addEventListener('timeupdate', () => { if (!audio.duration) return; document.getElementById('progress-fill').style.width = (audio.currentTime / audio.duration * 100) + '%'; document.getElementById('time-current').textContent = formatTime(audio.currentTime); document.getElementById('time-duration').textContent = formatTime(audio.duration); });

    document.getElementById('progress-container').addEventListener('click', e => { if (!audio.duration) return; const r = e.currentTarget.getBoundingClientRect(); audio.currentTime = ((e.clientX - r.left) / r.width) * audio.duration; });
    let seeking = false;
    document.getElementById('progress-container').addEventListener('touchstart', () => { seeking = true; }, { passive: true });
    document.getElementById('progress-container').addEventListener('touchmove', e => { if (!seeking || !audio.duration) return; const r = e.currentTarget.getBoundingClientRect(); const t = e.touches[0]; audio.currentTime = Math.max(0, Math.min(1, (t.clientX - r.left) / r.width)) * audio.duration; }, { passive: true });
    document.addEventListener('touchend', () => { seeking = false; });

    // â•â•â• RATING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function rateTrack(rating) {
      if (!sessionData) return;
      const track = sessionData.tracks[playQueue[queuePos]];
      if (!track) return;

      if (rating === null) {
        // Clear rating
        if (sessionData.ratings?.[track.id]) {
          delete sessionData.ratings[track.id].rating;
        }
        fetch(`/api/sessions/${currentSessionId}/rate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trackId: track.id, rating: null, title: track.title, imageUrl: track.imageUrl, style: track.style }) }).catch(() => { });
        document.querySelectorAll('.rate-btn').forEach(btn => btn.classList.remove('selected'));
        toast('Rating cleared');
        serverSync();
        return;
      }

      if (!sessionData.ratings) sessionData.ratings = {};
      sessionData.ratings[track.id] = {
        ...(sessionData.ratings[track.id] || {}),
        rating, title: track.title, imageUrl: track.imageUrl, style: track.style,
        updatedAt: new Date().toISOString(),
      };

      fetch(`/api/sessions/${currentSessionId}/rate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trackId: track.id, rating, title: track.title, imageUrl: track.imageUrl, style: track.style }) }).catch(() => { });

      document.querySelectorAll('.rate-btn').forEach(btn => {
        const r = btn.dataset.rating;
        btn.classList.toggle('selected', r === 'CLEAR' ? false : r === rating);
      });

      const labels = { TRASH: 'ğŸ—‘ï¸ Trashed', OK: 'ğŸ‘Œ OK', GOOD: 'ğŸ‘ Good', PERFECT: 'â­ Perfect' };
      toast(labels[rating] || rating);
      serverSync();

      if (rating === 'TRASH') {
        playQueue.splice(queuePos, 1);
        if (queuePos >= playQueue.length) queuePos = 0;
        if (playQueue.length === 0) { toast('All tracks rated! ğŸ‰'); showResults(); return; }
        loadTrack();
        return;
      }

      if (autoAdvance) {
        setTimeout(() => {
          playQueue.splice(queuePos, 1);
          if (playQueue.length === 0) { toast('All tracks rated! ğŸ‰'); showResults(); return; }
          if (queuePos >= playQueue.length) queuePos = 0;
          loadTrack();
        }, 400);
      }
    }

    function saveNote() {
      if (!sessionData) return;
      const track = sessionData.tracks[playQueue[queuePos]];
      if (!track) return;
      const note = document.getElementById('note-input').value.trim();
      if (!sessionData.ratings) sessionData.ratings = {};
      sessionData.ratings[track.id] = { ...(sessionData.ratings[track.id] || {}), note, updatedAt: new Date().toISOString() };
      document.getElementById('note-display-text').textContent = note ? `ğŸ“ ${note}` : '';
      fetch(`/api/sessions/${currentSessionId}/rate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ trackId: track.id, note }) }).catch(() => { });
      toast('Note saved');
    }

    function serverSync() {
      if (!currentSessionId || !sessionData) return;
      fetch(`/api/sessions/${currentSessionId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ratings: sessionData.ratings }) }).catch(() => { });
    }

    // â•â•â• TOGGLES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleShuffle() {
      shuffleOn = !shuffleOn; updateToggles();
      const cur = playQueue[queuePos]; buildQueue();
      const f = playQueue.indexOf(cur); queuePos = f !== -1 ? f : 0;
      updateCounter(); toast(shuffleOn ? 'Shuffle ON' : 'Shuffle OFF');
    }
    function toggleAutoAdvance() { autoAdvance = !autoAdvance; updateToggles(); toast(autoAdvance ? 'Auto-advance ON' : 'Auto-advance OFF'); }
    function updateToggles() { document.getElementById('shuffle-btn').classList.toggle('active', shuffleOn); document.getElementById('auto-advance-btn').classList.toggle('active', autoAdvance); }

    // â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showResults() { switchScreen('results-screen'); renderResults(); }
    function showPlayer() { switchScreen('player-screen'); }

    function filterResults(f) {
      currentFilter = f;
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.toggle('active', t.dataset.filter === f));
      renderResults();
    }

    function renderResults() {
      if (!sessionData) return;
      const list = document.getElementById('results-list');
      const items = sessionData.tracks.map(t => { const r = sessionData.ratings?.[t.id] || {}; return { ...t, rating: r.rating || null, note: r.note || '', updatedAt: r.updatedAt }; });

      let filtered = items;
      if (currentFilter === 'UNRATED') filtered = items.filter(i => !i.rating);
      else if (currentFilter !== 'ALL') filtered = items.filter(i => i.rating === currentFilter);

      if (filtered.length === 0) { list.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>No tracks in this category</p></div>'; return; }

      const order = { PERFECT: 0, GOOD: 1, OK: 2, TRASH: 3 };
      filtered.sort((a, b) => (order[a.rating] ?? 4) - (order[b.rating] ?? 4));

      list.innerHTML = filtered.map(item => `
    <div class="result-card" data-id="${item.id}">
      <div class="result-thumb"><img src="${item.imageUrl || ''}" alt="" onerror="this.parentElement.innerHTML='ğŸ¶';"></div>
      <div class="result-info">
        <div class="title">${escHtml(item.title || item.id.slice(0, 12) + '...')}</div>
        <div class="meta" title="Click to expand/collapse" onclick="this.classList.toggle('expanded')">${escHtml(item.style || '')} ${item.rating ? '' : 'Â· unrated'}</div>
        ${item.note ? `<div class="note">ğŸ“ ${escHtml(item.note)}</div>` : ''}
      </div>
      ${item.rating ? `<span class="result-badge badge-${item.rating}">${item.rating}</span>` : ''}
      <div class="result-actions">
        <button onclick="playFromResults('${item.id}')" title="Play">â–¶</button>
        <button onclick="window.open('https://suno.com/song/${item.id}','_blank')" title="Suno">ğŸ”—</button>
      </div>
    </div>
  `).join('');
    }

    function playFromResults(id) {
      if (!sessionData) return;
      const idx = sessionData.tracks.findIndex(t => t.id === id);
      if (idx === -1) return;
      switchScreen('player-screen');
      let qi = playQueue.indexOf(idx);
      if (qi === -1) { playQueue.push(idx); qi = playQueue.length - 1; }
      queuePos = qi; loadTrack();
    }

    // â•â•â• EXPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function exportRatings() {
      if (!sessionData) return;
      downloadBlob(JSON.stringify(sessionData, null, 2), `suno-session-${sessionData.name}.json`, 'application/json');
      toast('Exported');
    }

    function downloadPerfect() {
      if (!sessionData) return;
      const perfect = sessionData.tracks.filter(t => sessionData.ratings?.[t.id]?.rating === 'PERFECT');
      if (!perfect.length) { toast('No PERFECT tracks'); return; }
      const text = perfect.map(t => { const r = sessionData.ratings[t.id]; return `${t.title || t.id}\n  Download: https://cdn1.suno.ai/${t.id}.mp3\n  Suno: https://suno.com/song/${t.id}${r?.note ? '\n  Note: ' + r.note : ''}`; }).join('\n\n');
      downloadBlob(text, 'perfect-tracks.txt', 'text/plain');
      toast(`${perfect.length} perfect track(s) listed`);
    }

    function copyRatingSummary() {
      if (!sessionData) return;
      const lines = [], groups = { PERFECT: [], GOOD: [], OK: [], TRASH: [] };
      sessionData.tracks.forEach(t => { const r = sessionData.ratings?.[t.id]; if (r?.rating && groups[r.rating]) groups[r.rating].push(`  ${t.title || t.id}${r.note ? ' â€” ' + r.note : ''}`); });
      for (const [l, items] of Object.entries(groups)) { if (items.length > 0) { lines.push(`${l} (${items.length}):`, ...items, ''); } }
      navigator.clipboard.writeText(lines.join('\n')).then(() => toast('Summary copied!')).catch(() => toast('Copy failed'));
    }

    function downloadBlob(c, f, t) { const b = new Blob([c], { type: t }), u = URL.createObjectURL(b), a = document.createElement('a'); a.href = u; a.download = f; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(u); }
    function openSunoPage() { if (!sessionData) return; const t = sessionData.tracks[playQueue[queuePos]]; if (t) window.open(`https://suno.com/song/${t.id}`, '_blank'); }

    // â•â•â• KEYBOARD SHORTCUTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (!document.getElementById('player-screen').classList.contains('active')) return;
      switch (e.key) {
        case '1': rateTrack('TRASH'); break; case '2': rateTrack('OK'); break; case '3': rateTrack('GOOD'); break; case '4': rateTrack('PERFECT'); break;
        case '0': rateTrack(null); break;
        case ' ': e.preventDefault(); togglePlay(); break;
        case 'n': case 'N': document.getElementById('note-input').focus(); break;
        case 'ArrowRight': nextTrack(); break; case 'ArrowLeft': prevTrack(); break;
        case 's': case 'S': toggleShuffle(); break; case 'r': case 'R': showResults(); break;
      }
    });

    // â•â•â• ICON Picker â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initIconPicker() {
      const picker = document.getElementById('icon-picker');
      picker.innerHTML = SESSION_ICONS.map(icon =>
        `<button type="button" class="${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon(this,'${icon}')">${icon}</button>`
      ).join('') + `<input type="text" class="custom-icon-input" placeholder="+" maxlength="2"
                      onfocus="selectCustomIcon(this)" oninput="updateCustomIcon(this)" 
                      title="Paste a custom emoji or symbol" />`;
    }
    function selectIcon(btn, icon) {
      selectedIcon = icon;
      document.querySelectorAll('#icon-picker button').forEach(b => b.classList.remove('selected'));
      const customInp = document.querySelector('.custom-icon-input');
      if (customInp) { customInp.classList.remove('selected'); customInp.value = ''; }
      btn.classList.add('selected');
    }
    function selectCustomIcon(inp) {
      document.querySelectorAll('#icon-picker button').forEach(b => b.classList.remove('selected'));
      inp.classList.add('selected');
      if (inp.value) selectedIcon = inp.value;
    }
    function updateCustomIcon(inp) {
      if (inp.value) {
        selectedIcon = inp.value;
      }
    }

    // â•â•â• EDIT SESSION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initEditIconPicker() {
      const picker = document.getElementById('edit-icon-picker');
      picker.innerHTML = SESSION_ICONS.map(icon =>
        `<button type="button" class="${icon === editSelectedIcon ? 'selected' : ''}" onclick="selectEditIcon(this,'${icon}')">${icon}</button>`
      ).join('') + `<input type="text" class="custom-icon-input" placeholder="+" maxlength="2"
                      onfocus="selectCustomEditIcon(this)" oninput="updateCustomEditIcon(this)" />`;
    }
    function selectEditIcon(btn, icon) {
      editSelectedIcon = icon;
      document.querySelectorAll('#edit-icon-picker button').forEach(b => b.classList.remove('selected'));
      const customInp = document.querySelector('#edit-icon-picker .custom-icon-input');
      if (customInp) { customInp.classList.remove('selected'); customInp.value = ''; }
      btn.classList.add('selected');
    }
    function selectCustomEditIcon(inp) {
      document.querySelectorAll('#edit-icon-picker button').forEach(b => b.classList.remove('selected'));
      inp.classList.add('selected');
      if (inp.value) editSelectedIcon = inp.value;
    }
    function updateCustomEditIcon(inp) {
      if (inp.value) editSelectedIcon = inp.value;
    }

    function switchEditTab(tab) {
      editTabMode = tab;
      document.getElementById('edit-tab-ids-content').classList.toggle('hidden', tab !== 'ids');
      document.getElementById('edit-tab-workspace-content').classList.toggle('hidden', tab !== 'workspace');
      document.getElementById('edit-tab-ids').classList.toggle('active', tab === 'ids');
      document.getElementById('edit-tab-workspace').classList.toggle('active', tab === 'workspace');
    }

    function openEditModal(id, name, icon) {
      editingSessionId = id;
      document.getElementById('edit-session-name').value = name;
      editSelectedIcon = icon;
      initEditIconPicker();
      document.getElementById('edit-track-ids').value = '';
      document.getElementById('edit-workspace-id').value = '';
      hideError('edit-error');
      document.getElementById('edit-session-modal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('edit-session-modal').classList.add('hidden');
      editingSessionId = null;
    }

    async function saveEditedSession() {
      const name = document.getElementById('edit-session-name').value.trim();
      if (!name) { showError('edit-error', 'Session name required'); return; }
      hideError('edit-error');

      let newTracks = [];
      const rawIds = document.getElementById('edit-track-ids').value.trim();
      const wid = document.getElementById('edit-workspace-id').value.trim();

      document.getElementById('edit-save-btn').classList.add('hidden');
      document.getElementById('edit-loading').classList.remove('hidden');

      if (editTabMode === 'ids' && rawIds) {
        let ids = rawIds.replace(/[\[\]"']/g, '').split(/[\n,\s]+/).map(s => s.trim()).filter(s => /^[a-f0-9-]{36}$/i.test(s));
        ids = [...new Set(ids)];
        if (ids.length > 0) {
          try {
            const auth = localStorage.getItem('sunoAuthToken') || '';
            const r = await fetch('/api/metadata', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': auth }, body: JSON.stringify({ ids }) });
            const d = await r.json();
            if (!r.ok) throw new Error(d.error);
            newTracks = d.tracks;
          } catch (e) {
            showError('edit-error', e.message);
            document.getElementById('edit-save-btn').classList.remove('hidden');
            document.getElementById('edit-loading').classList.add('hidden');
            return;
          }
        }
      } else if (editTabMode === 'workspace' && wid) {
        try {
          const auth = localStorage.getItem('sunoAuthToken') || '';
          const r = await fetch('/api/workspace', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': auth }, body: JSON.stringify({ workspaceId: wid }) });
          const d = await r.json();
          if (!r.ok) throw new Error(d.error);
          newTracks = d.tracks;
        } catch (e) {
          showError('edit-error', e.message);
          document.getElementById('edit-save-btn').classList.remove('hidden');
          document.getElementById('edit-loading').classList.add('hidden');
          return;
        }
      }

      try {
        const body = { name, icon: editSelectedIcon };
        if (newTracks.length > 0) body.newTracks = newTracks;
        const r = await fetch(`/api/sessions/${editingSessionId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const d = await r.json();
        if (!r.ok) throw new Error(d.error);
        toast(newTracks.length > 0 ? `Saved session and imported ${newTracks.length} tracks` : `Session updated`);
        closeEditModal();
        refreshHome();
      } catch (e) {
        showError('edit-error', e.message);
      } finally {
        document.getElementById('edit-save-btn').classList.remove('hidden');
        document.getElementById('edit-loading').classList.add('hidden');
      }
    }

    // â•â•â• PASSWORD PROMPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function promptPassword() {
      return new Promise(resolve => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = `
          <div class="modal-box">
            <div style="font-size:36px;">ğŸ”’</div>
            <div style="font-size:16px;font-weight:600;">Session Protected</div>
            <div class="input-group" style="max-width:100%;">
              <label>Password</label>
              <input type="password" id="unlock-password" placeholder="Enter password" autofocus>
            </div>
            <div id="unlock-error" class="error-text hidden"></div>
            <div style="display:flex;gap:8px;width:100%;">
              <button class="btn btn-secondary" style="flex:1;" id="unlock-cancel">Cancel</button>
              <button class="btn btn-primary" style="flex:1;" id="unlock-submit">Unlock</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
        const inp = overlay.querySelector('#unlock-password');
        setTimeout(() => inp.focus(), 100);
        overlay.querySelector('#unlock-cancel').onclick = () => { overlay.remove(); resolve(null); };
        overlay.querySelector('#unlock-submit').onclick = () => { overlay.remove(); resolve(inp.value); };
        inp.addEventListener('keydown', e => { if (e.key === 'Enter') { overlay.remove(); resolve(inp.value); } });
      });
    }

    // â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    initIconPicker();
    refreshHome();
  </script>
</body>

</html>